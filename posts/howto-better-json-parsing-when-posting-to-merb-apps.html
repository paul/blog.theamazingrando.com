
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <title>The Amazing Blog - HOWTO: Better JSON parsing when POSTing to Merb Apps</title>

    <title>HOWTO: Better JSON parsing when POSTing to Merb Apps</title>
<meta name="description" content="Inaccurate Posts from the Inscrutable Mind of Paul Sadauskas" />
<meta name="keywords" content="software, ruby, linux" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="Inaccurate Posts from the Inscrutable Mind of Paul Sadauskas" />
<meta name="twitter:image:src" content="/avatar.jpg" />
<meta name="twitter:title" content="HOWTO: Better JSON parsing when POSTing to Merb Apps" />
<meta property="og:description" content="Inaccurate Posts from the Inscrutable Mind of Paul Sadauskas" />
<meta property="og:image" content="/avatar.jpg" />
<meta property="og:title" content="HOWTO: Better JSON parsing when POSTing to Merb Apps" />
    <script type="application/ld+json">
      {
        "@type": "WebSite",
        "publisher": {
          "@type": "Person",
          "logo": {
            "@type": "ImageObject",
            "url": "/avatar.png"
          }
        },
        "url": "/",
        "headline": "HOWTO: Better JSON parsing when POSTing to Merb Apps",
        "name": "The Amazing Blog",
        "@context": "https://schema.org"
      }
    </script>

    <link href="/stylesheets/txt.css" rel="stylesheet" />
    <link href="/stylesheets/highlight.css" rel="stylesheet" />
    <link rel="alternate" type="application/atom+xml" title="The Amazing Blog Feed" href="/feed.xml" />
  </head>
  <body class="is-preload">
    <div id="page-wrapper">

    <header id="header">
      <div class="logo container">
        <div>
          <h1>
              HOWTO: Better JSON parsing when POSTing to Merb Apps
          </h1>
        </div>
      </div>
    </header>

    <nav id="nav">
      <ul>
        <li class="current"><a href="/">Home</a></li>
      </ul>
    </nav>


    <section id="main" role="main">
      <div class="container">
        <div class="row">
          <div class="col-9 col-12-medium">
            <div class="content">
              <article class="box page-content">
                  <section>
    <header>
      <h2><a href="/posts/howto-better-json-parsing-when-posting-to-merb-apps.html">HOWTO: Better JSON parsing when POSTing to Merb Apps</a></h1>
      <ul class="meta">
        <li class="icon fa-upload">
          Published: <time datetime="2008-10-10T02:43:55Z">Friday, October 10th 2008</time>
        <li>
        <li class="icon fa-clock">
          Updated: <time datetime="2017-02-07T16:49:25-07:00">Tuesday, February 7th 2017</time></br>
        <li>
        <li class="icon brands fa-github">
          <a href="https://github.com/paul/blog.theamazingrando.com/blob/master/source/posts/howto-better-json-parsing-when-posting-to-merb-apps.html.markdown">Article source on GitHub</a>
        </li>
      </ul>
      <ul class="meta">
          <li class="icon fa-tag">Ruby<li>
          <li class="icon fa-tag">Merb<li>
      </ul>
    </header>

    <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>

<p>Where I work, we have fairly extensive, JSON-based web services in all out applications. As a quick example, here's what you would get if you were to <code>GET</code> <code>http://config.ssbe.example.com/configurations/90</code> with the mime-type <code>application/vnd.absperf.sscj1+json</code>:</p>
<div class="highlight"><pre class="highlight plaintext"><code>{
  "_type":                      "Configuration",
  "href":                       "http://config.ssbe.localhost/configurations/90",
  "id":                         "4c5895f2-28a3-4299-a558-270889e6f065",
  "name":                       "lacquered",
  "notes":                      "Hosted hundredfold broomstick",
  "platform":                   "AIX",
  "client_href":                "http://core.ssbe.localhost/clients/jousting",
  "registered_templates_href":  "http://config.ssbe.localhost/configurations/90/registered_templates",
  "parent_configuration_href":  "http://config.ssbe.localhost/configurations/90",
  "created_at":                 "2008-10-07T16:38:29-06:00",
  "updated_at":                 "2008-10-08T15:20:51-06:00"
}
</code></pre></div>
<p>I'm planning on a bigger post about exactly what our JSON document means, and our mime-types, and everything. For now, a good explaination of the reasoning behind our mime-types can be found <a href="http://barelyenough.org/blog/2008/05/versioning-rest-web-services/">over on Peter's blog</a>.</p>

<p>That aside, now that I've <code>GET</code>ed this document, I'd love to be able to just string-manipulate the one or two things I want to modify, and just <code>PUT</code> it back where I got it, in the same format, with all the same attributes. The problem with that, though, is that several of these attributes are determined server-side, such as <code>_type</code>, <code>href</code>, and <code>id</code>. These values a set by the server, and a few of them aren't even properties on the model. I could throw an error back when someone tries to submit a value for an unchangeable attribute, but then I wouldn't be able to <code>POST</code> the identical document that I just <code>GET</code>ed. I'd have to know a fair amount about the document to know which attributes I have to remove from the document before I can give it back. I'd much prefer the server just ignore it. Now, I could throw an error if someone tries to <em>change</em> one of these attributes, but I'll save that for later. In any event, right now, I just want my controller to parse the JSON, and let it ignore the attributes I don't care about.</p>

<p>To that end, I implemented a custom JSON parser in a before filter in my Application controller:</p>
<div class="highlight"><pre class="highlight plaintext"><code>class Application &lt; Merb::Controller
  before :parse_supplied_sscj1, :if =&gt; :has_sscj1_content         #[1]

  def has_sscj1_content
    request.content_type == 'application/vnd.absperf.sscj1+json'  #[2]
  end

  def parse_supplied_sscj1
    begin
      jobj = JSON.parse(request.raw_post)                         #[3]
      raise UnprocessableEntity unless jobj.is_a?(Hash)           #[4]

      model_class = jobj["_type"].snake_case                      #[5]

      params[model_class] = jobj
    rescue JSON::ParserError =&gt; e
      raise BadRequest.new(e.message)                             #[6]
    end
  end
end
</code></pre></div>
<p>A brief description of what all this means:</p>

<ol>
<li>Set up the before filter to do the parsing, but only under the right conditions.</li>
<li>Those conditions are merely if somebody set the <code>Content-Type</code> header on the request to my <code>sscj1</code> mime-type.</li>
<li>JSON parse the body of the request. Request#raw_post is how you get to the raw data that was <code>POST</code>ed (and <code>PUT</code>, too)</li>
<li>I expect every JSON document i get to be parsed into a Hash object, so throw a standard HTTP error if its not.</li>
<li>Because I have the <code>_type</code> attribute in my document, I can use that to put the parsed attributes in the right place. From the example above, I end up with <code>params = {"configuration" =&gt; {"name" =&gt; "lacquered", ...}, ...}</code>
</li>
<li>Oh, and if we got an invalid (unparseable) JSON document, raise a 400 Bad Request error.</li>
</ol>

<p>So that takes care of the JSON parsing. Its a little better than the one built-in to merb, because of the error handling, and putting the attributes into a useable place in the form. Now, what do we do about the attributes we want to ignore? I added a couple class methods to Controller for handling that.</p>
<div class="highlight"><pre class="highlight plaintext"><code>class Application &lt; Merb::Controller
  class &lt;&lt; self
    attr_accessor :attributes_to_ignore

    def ignore_attributes(*attrs)
      @attributes_to_ignore = attrs
    end

  end

  def attributes_to_ignore
    %w[_type href id created_at updated_at] + self.class.attributes_to_ignore
  end

end

class Configurations &lt; Application
  provides :sscj1

  ignore_attributes 'registered_templates_href'

  # ...
end
</code></pre></div>
<p>This is all pretty simple. Essentially, I just added a <code>#ignore_attributes</code> class method to my controllers, so I can provide a list of attributes to be ignored, specific to each controller. The <code>#attributes_to_ignore</code> method lists the default ones, and in this case, I want my configurations to ignore <code>registered_templates_href</code> in addition to those. Now I can just delete those from the parsed JSON object in my <code>#parse_supplied_sscj1</code> method:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  attributes_to_ignore.each do |key|
    jobj.delete(key)
  end
</code></pre></div>
<p>Simple!</p>

<p>Now, I have that pesky <code>parent_configuration_href</code> attribute still coming in. I dont want to ignore it, but I do need a <code>parent_id</code> attribute in my configuration model, representing a self-referential join. To do that, I'd love to be able to run the given uri through merb's router and parse out the <code>id</code>, but unfortunetly, thats not part of the public API (yet). I'll just have to write my own simple regex parser to pull it out, and have a nice clever way to set that in my Configurations controller. So on to the code:</p>
<div class="highlight"><pre class="highlight plaintext"><code>class Application &lt; Merb::Controller
  class &lt;&lt; self
    attr_accessor :attributes_to_alter
    def alter_attribute(attribute, &amp;block)
      @attributes_to_alter ||= {}
      @attributes_to_alter[attribute] = block
    end
  end
  def attributes_to_alter
    Merb.logger.info self.class.attributes_to_alter.inspect
    self.class.attributes_to_alter || {}
  end

end

class Configurations &lt; Application
  provides :sscj1

  alter_attribute 'parent_configuration_href' do |_,uri|
    {'parent_id' =&gt; extract_configuration_id(uri)}
  end

  def self.extract_configuration_id(uri)
    return nil unless uri
    %r{/configurations/(\d+)}.match(uri)
    $1
  end

end
</code></pre></div>
<p>So, here we have something similar to the <code>#ignore_attributes</code>, except now we have a block to be called on the attribute we want to change. In this case, I match the <code>configurations</code> part of the URI, and capture the <code>id</code>. Then , in my <code>#parse_supplied_sscj1</code> method, I replace the old value with the new one:</p>
<div class="highlight"><pre class="highlight plaintext"><code>def parse_supplied_sscj1
  begin
    jobj = JSON.parse(request.raw_post)
    raise UnprocessableEntity unless jobj.is_a?(Hash)

    model_class = jobj["_type"].snake_case

    attributes_to_ignore.each do |key|
      jobj.delete(key)
    end

    attributes_to_alter.each do |attribute, block|
      new_attrs = block.call(attribute, jobj.delete(attribute))
      jobj.merge!(new_attrs)
    end

    params[model_class] = jobj
  rescue JSON::ParserError =&gt; e
    raise BadRequest.new(e.message)
  end
end
</code></pre></div>
<p>Thats the entire method that I'm using right now. I hope to package this all up as a merb plugin soon, keep and eye on my github, and I'll probably post something about it here, soon.</p>
</body></html>

  </section>

              </article>
            </div>
          </div>
          <div class="col-3 col-12-medium">
            <div class="sidebar">
              <section>
  <h2 class="major"><span>About Me</span></h2>
  <a href="#" class="image featured">
    <img src="/avatar.jpg" alt="avatar" />
  </a>
  <p>
  Paul Sadauskas is a professional software engineer in Boulder, CO. I love
  making tools for users and fellow developers that are elegant, robust, and
  reliable.
  </p>

  <ul style="list-style: none">
    <li class="icon brands fa-github">&nbsp;<a href="https://github.com/paul">@paul</a></li>
    <li class="icon brands fa-mastodon">&nbsp;<a rel="me" href="https://ruby.social/@Paul">ruby.social@Paul</a></li>
    <li class="icon brands fa-twitter">&nbsp;<a href="https://twitter.com/theamazingrando">@theamazingrando</a></li>
    <li class="icon fa-envelope">&nbsp;<a href="mailto:paul@sadauskas.com">paul@sadauskas.com</a></li>
  </ul>
</section>

<section>
  <h2>Tags</h2>
  <div class="nav-section">
    <ul class="tags">
        <li>
          <a href="/tagged/aws.html">AWS</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/authentication.html">Authentication</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/datamapper.html">DataMapper</a>&nbsp;(8)
        </li>
        <li>
          <a href="/tagged/dryrb.html">DryRb</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/gentoo.html">Gentoo</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/hypermedia.html">Hypermedia</a>&nbsp;(4)
        </li>
        <li>
          <a href="/tagged/let-s-encrypt.html">Let's Encrypt</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/linux.html">Linux</a>&nbsp;(2)
        </li>
        <li>
          <a href="/tagged/logging.html">Logging</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/merb.html">Merb</a>&nbsp;(3)
        </li>
        <li>
          <a href="/tagged/mysql.html">MySQL</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/postgres.html">Postgres</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/progress-bar.html">Progress Bar</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/rails.html">Rails</a>&nbsp;(6)
        </li>
        <li>
          <a href="/tagged/resourceful.html">Resourceful</a>&nbsp;(3)
        </li>
        <li>
          <a href="/tagged/ruby.html">Ruby</a>&nbsp;(17)
        </li>
        <li>
          <a href="/tagged/meta.html">meta</a>&nbsp;(1)
        </li>
        <li>
          <a href="/tagged/tips.html">tips</a>&nbsp;(1)
        </li>
    </ul>
  </div>
</section>

            </div>
          </div>
        </div>
      </div>
    </section>

    <footer id="footer">
  <div class="container">
    <div id="copyright">
      <ul class="menu">
        <li>
          <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">
            The Amazing Blog
          </span>
          by
          <a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.theamazingrando.com" property="cc:attributionName" rel="cc:attributionURL">
            Paul Sadauskas
          </a>
        </li>
        <li>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
        </li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
      </ul>
    </div>
  </div>
</footer>


    </div>
    <script data-goatcounter="https://rando.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </body>
</html>
